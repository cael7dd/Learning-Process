var Block=function(){function c(b,a,d,e){this._img=b;this._size=a;this.isRight=!0;this._originX=this._x=d;this._originY=this._y=e;this._poiX=d*this._size;this._poiY=e*this._size;this.createBlock()}c.prototype.createBlock=function(){this._block=new createjs.Bitmap(this._img);var b=this._block.getBounds(),a,d=0,e=0;b.width>=b.height?(a=500/b.height,d=(b.width-500)/2*a):(a=500/b.width,e=(b.height-500)/2*a);d+=this._poiX/a;e+=this._poiY/a;this._block.sourceRect=new createjs.Rectangle(d,e,this._size/a,
this._size/a);this._block.scaleX=a;this._block.scaleY=a;this._block.x=this._poiX;this._block.y=this._poiY};c.prototype.getBlock=function(){return this._block};c.prototype.getX=function(){return this._x};c.prototype.getY=function(){return this._y};c.prototype.getOriginX=function(){return this._originX};c.prototype.getOriginY=function(){return this._originY};c.prototype.setX=function(b){this._x=b;this._block.x=this._x*this._size};c.prototype.setY=function(b){this._y=b;this._block.y=this._y*this._size};
return c}(),Main=function(){function c(){this._busy=!1;this.init()}c.prototype.init=function(){this._btnRandom=document.querySelector("#random");this._level=5;this._iptLevel=document.querySelector("#d_level");this._iptLevel.value=this._level-1;this._imgPath="src/1.jpg";this._stage=new createjs.Stage("canvas");this._iptFile=document.querySelector("#ipt_file");this.addImage();this.startNewLevel()};c.prototype.startNewLevel=function(){this._stage.removeAllChildren();this._blockArray=[];this._random=
!1;this._btnRandom.innerHTML="\u5f00\u59cb\u6253\u4e71";createjs.Ticker.addEventListener("tick",this._stage);this._busy=!1;this._aniDur=200-199/9*(this._level-2);this._blockAmount=Math.pow(this._level,2)-1;this._wrongNum=0;this._size=500/this._level;this.addBlocks();this._blankX=this._blankY=this._level-1;this._movedX=!1;this.addListeners()};c.prototype.addBlocks=function(){for(var b=this._level,a=0;a<this._level;a++){a==this._level-1&&(b=this._level-1);for(var d=0;d<b;d++){var e=new Block(this._imgPath,
this._size,a,d);this._blockArray.push(e);this._stage.addChild(e.getBlock())}}};c.prototype.addImage=function(){var b=this,a=new FileReader;this._iptFile.addEventListener("change",function(d){"image/jpeg"==d.target.files[0].type&&(a.onload=function(){b._imgPath=a.result;b.startNewLevel()},a.readAsDataURL(d.target.files[0]))})};c.prototype.addListeners=function(){for(var b=this,a=this,d=0;d<this._blockArray.length;d++)(function(b){a._blockArray[b].getBlock().addEventListener("click",function(){if(0==
Math.abs(a._blockArray[b].getX()-a._blankX)*Math.abs(a._blockArray[b].getY()-a._blankY)&&1>=Math.abs(a._blockArray[b].getX()-a._blankX)&&1>=Math.abs(a._blockArray[b].getY()-a._blankY)&&!a._busy){a._busy=!0;var d=a._blankX,c=a._blankY;a.judgeResult.call(a,a._blockArray[b],d,c);createjs.Tween.get(a._blockArray[b].getBlock()).to({x:a._blankX*a._size,y:a._blankY*a._size},300).call(function(){a._blockArray[b].setX(d);a._blockArray[b].setY(c);a._busy=!1},this);a._blankX=a._blockArray[b].getX();a._blankY=
a._blockArray[b].getY()}})})(d);this._btnRandom.onclick=function(){b._random?(b._busy=!1,b._random=!1,b._btnRandom.innerHTML="\u5f00\u59cb\u6253\u4e71"):(b._busy=!0,b._random=!0,b._btnRandom.innerHTML="\u505c\u6b62\u6253\u4e71",b.findNextMove())};this._iptLevel.addEventListener("input",function(){var a=parseInt(b._iptLevel.value),a=Math.max(0,a),a=Math.min(10,a);b._iptLevel.value=a});this._iptLevel.addEventListener("blur",function(){b._level=parseInt(b._iptLevel.value)+1;b.startNewLevel()})};c.prototype.judgeResult=
function(b,a,d){var c=b.getOriginX(),f=b.getOriginY();a!=c||d!=f||b.isRight?a==c&&d==f||!b.isRight||(this._wrongNum++,b.isRight=!1):(this._wrongNum--,b.isRight=!0);this._random||0!=this._wrongNum||alert("\u606d\u559c\u8fc7\u5173\uff01")};c.prototype.addBlockAnimation=function(b,a){var d=this,c=this.getNextBlock(this._blankX,this._blankY);this.judgeResult.call(this,c,b,a);createjs.Tween.get(c.getBlock()).to({x:b*this._size,y:a*this._size},this._aniDur).call(function(){c.setX(b);c.setY(a);createjs.Tween.removeAllTweens();
d.findNextMove()})};c.prototype.findNextMove=function(){this._random?this._movedX?(this.randomDir("_blankY"),this._movedX=!1):(this.randomDir("_blankX"),this._movedX=!0):createjs.Tween.removeAllTweens()};c.prototype.randomDir=function(b){0>this[b]-1||.5<=Math.random()&&this[b]+1<this._level?(this[b]++,"_blankX"==b?this.addBlockAnimation.call(this,this._blankX-1,this._blankY):this.addBlockAnimation.call(this,this._blankX,this._blankY-1)):(this[b]--,"_blankX"==b?this.addBlockAnimation(this._blankX+
1,this._blankY):this.addBlockAnimation(this._blankX,this._blankY+1))};c.prototype.getNextBlock=function(b,a){for(var c=0;c<this._blockArray.length;c++)if(this._blockArray[c].getX()==b&&this._blockArray[c].getY()==a)return this._blockArray[c]};return c}();new Main;
