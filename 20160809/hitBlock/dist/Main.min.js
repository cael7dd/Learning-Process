var Ball=function(){function a(b,a,c,d,e,f){this._x=b;this._y=a;this._size=c;this._speed=d;this._angle=e;this._id=f;this._stepX=this._speed*Math.cos(this._angle);this._stepY=this._speed*Math.sin(this._angle);this._fallen=!1;this.createBall()}a.prototype.createBall=function(){this._ball=new createjs.Shape;this._ball.graphics.beginFill("#fff");this._ball.graphics.drawCircle(0,0,this._size);this._ball.graphics.endFill();this._ball.x=this._x;this._ball.y=this._y;this._ball.addEventListener("tick",this.moveBall.bind(this))};
a.prototype.moveBall=function(){this._ball.x+=this._stepX;this._ball.y-=this._stepY;this.judgeHit()};a.prototype.judgeHit=function(){if(this._ball.x<=this._size||this._ball.x>=window.innerWidth-this._size)this._angle=Math.PI-this._angle,this.adjustStep();this._ball.y<=this._size&&(this._angle=-this._angle,this.adjustStep());this._ball.y>=window.innerHeight+this._size+2&&(this._fallen=!0,this._ball.removeAllEventListeners("tick"))};a.prototype.getID=function(){return this._id};a.prototype.adjustStep=
function(){this._stepX=this._speed*Math.cos(this._angle);this._stepY=this._speed*Math.sin(this._angle)};a.prototype.getX=function(){return this._ball.x};a.prototype.getY=function(){return this._ball.y};a.prototype.setAngle=function(b){this._angle=b?Math.PI-this._angle:-this._angle;this.adjustStep()};a.prototype.isFallen=function(){return this._fallen};a.prototype.getBall=function(){return this._ball};return a}(),Block=function(){function a(b,a,c,d,e){this._x=b;this._y=a;this._size=c;this._amount=
d;this._strokeWidth=e;this._lastHitBall=-2;this._poiX=this._x*(this._size+2*this._strokeWidth)+this._strokeWidth;this._poiY=this._y*(this._size+2*this._strokeWidth)+this._strokeWidth;this.createBlock()}a.prototype.changeColor=function(){this._text.color="hsl("+20*this._amount+",100%,50%)";return"hsl(40"+20*this._amount+",100%,50%)"};a.prototype.getLastHitBall=function(){return this._lastHitBall};a.prototype.setLastHitBall=function(b){this._lastHitBall=b};a.prototype.createBlock=function(){this._container=
new createjs.Container;this._block=new createjs.Shape;this._text=new createjs.Text(this._amount,"20px Arial","red");this._block.graphics.setStrokeStyle(this._strokeWidth,"round").beginStroke(this.changeColor());this._block.graphics.drawRect(0,0,this._size,this._size);this._text.x=this._size/2-10;this._text.y=this._size/2-10;this._container.addChild(this._block,this._text);this._container.x=this._poiX;this._container.y=this._poiY};a.prototype.getBlock=function(){return this._container};a.prototype.getRect=
function(){return this._block};a.prototype.minusText=function(){this._amount--;this._text.text=this._amount;this.changeColor()};a.prototype.getPoiX=function(){return this._poiX};a.prototype.getPoiY=function(){return this._poiY};a.prototype.getText=function(){return this._amount};a.getColor=function(b){};return a}(),Main=function(){function a(){this._level=1;this.init()}a.prototype.init=function(){this._newBallCount=9;this._stage=new createjs.Stage("canvas");createjs.Ticker.addEventListener("tick",
this.upDateStage.bind(this));createjs.Ticker.timingMode=createjs.Ticker.RAF;this._ballAmount=1;this._blockStrokeWidth=2;this._stageWidth=window.innerWidth;this._stageHeight=window.innerHeight;this._stage.autoClear=!0;this._ballShow=0;this._ballSpeed=this._ballSize=10;this._level=1;this._shooting=!1;this._blockMar=new createjs.Container;this._stage.addChild(this._blockMar);this._blockContainer=[];this._ballContainer=[];this.addBlock();this.addListeners()};a.prototype.upDateStage=function(){this._stage.update();
this._shooting&&(this.judgeFallen(),this.judgeHit());0!=this._ballShow&&(this._newBallCount++,10==this._newBallCount&&(this.addBall(),this._newBallCount=0,this._ballShow--))};a.prototype.addBlock=function(){this._blockSize=this._stageWidth/5-2*this._blockStrokeWidth;for(var b=0;5>b;b++)if(.5>Math.random()){var a=new Block(b,1-this._level,this._blockSize,Math.max(1,Math.round(this._level*Math.random())),this._blockStrokeWidth);this._blockContainer.push(a);this._blockMar.addChild(a.getBlock())}};a.prototype.addListeners=
function(){var b=this,a,c,d,e,f,g=new createjs.Shape;this._stage.addChild(g);document.addEventListener("touchstart",function(b){a=b.touches[0].pageX;c=b.touches[0].pageY});document.addEventListener("touchmove",function(h){d=h.touches[0].pageX;e=h.touches[0].pageY;g.graphics.clear();b._shooting||(g.graphics.beginStroke("#fff"),g.graphics.moveTo(b._stageWidth/2,b._stageHeight),f=Math.acos((d-a)/Math.sqrt(Math.pow(a-d,2)+Math.pow(c-e,2))),g.graphics.lineTo(1E3*Math.cos(f)+180,1E3*-Math.sin(f)+640))});
document.addEventListener("touchend",function(){!b._shooting&&e<c&&(b._shootAngle=f,b._ballShow=b._ballAmount,b._newBallCount=9,g.graphics.clear())})};a.prototype.judgeHit=function(){for(var b=0;b<this._ballContainer.length;b++)for(var a=0;a<this._blockContainer.length;a++){var c=this._ballContainer[b],d=this._blockContainer[a];if(d.getLastHitBall()!=c.getID()){var e=c.getX(),f=c.getY(),g=d.getPoiX(),h=d.getPoiY()+this._blockMar.y;f+this._blockStrokeWidth+2>=h&&f-this._blockStrokeWidth-2<=h+this._blockSize&&
(Math.abs(e+this._ballSize-g)<=this._ballSpeed||Math.abs(e-this._ballSize-g-this._blockSize)<=this._ballSpeed)?(this.hitBlock(a,b,!0),d.setLastHitBall(c.getID())):e+this._blockStrokeWidth+2>=g-this._blockStrokeWidth-2&&e<=g+this._blockSize&&(Math.abs(f+this._ballSize-h)<=this._ballSpeed||Math.abs(f-this._ballSize-h-this._blockSize)<=this._ballSpeed)&&(this.hitBlock(a,b,!1),d.setLastHitBall(c.getID()))}}};a.prototype.hitBlock=function(a,k,c){this._ballContainer[k].setAngle(c);k=this._blockContainer[a];
k.minusText();0==k.getText()&&(this._blockMar.removeChild(k.getBlock()),this._blockContainer.splice(a,1))};a.prototype.judgeFallen=function(){for(var a=0;a<this._ballContainer.length;a++)this._ballContainer[a].isFallen()&&(this._stage.removeChild(this._ballContainer[a].getBall()),this._ballContainer.splice(a,1),a--,0==this._ballContainer.length&&(this._shooting=!1,this.nextLevel()))};a.prototype.nextLevel=function(){for(var a=0;a<this._blockContainer.length;a++)this._blockContainer[a].setLastHitBall(-2);
this._blockMar.y+=this._blockSize+2*this._blockStrokeWidth;this._level++;this.addBlock();this._ballAmount++};a.prototype.addBall=function(){this._shooting=!0;var a=new Ball(this._stageWidth/2,this._stageHeight-10,this._ballSize,this._ballSpeed,this._shootAngle,this._ballAmount-this._ballShow);this._ballContainer.push(a);this._stage.addChild(a.getBall())};return a}();new Main;
